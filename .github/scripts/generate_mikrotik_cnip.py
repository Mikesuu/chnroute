# filename: scripts/generate_mikrotik_cnip.py
import os
import requests
from datetime import datetime

# 配置
# 原始的 CNIP 列表 URL
CIDRS_CN_URL = "https://raw.githubusercontent.com/zhiyi7/gfw-pac/master/cidrs-cn.txt"
# 输出到 GitHub 仓库的文件路径
OUTPUT_FILE = "output/mikrotik_cn_ip.rsc"
# Mikrotik 地址列表名称
ADDRESS_LIST_NAME = "CN_IP_LIST"
COMMENT = "China IP - Generated by Mikesuu/chnroute"

# 您手动指定的局域网网段 (例如：10.10.10.0/25)
STATIC_LOCAL_NETS = [
    "10.10.10.0/25",
    # 可以在此添加更多您希望固定的本地网段
]

def fetch_cidrs(url, timeout=15):
    """从URL下载CIDR列表"""
    print(f"[FETCH] Downloading CIDRs from {url}")
    try:
        r = requests.get(url, timeout=timeout)
        r.raise_for_status()
        # 只保留非空、非注释的行
        lines = [line.strip() for line in r.text.splitlines() if line.strip() and not line.startswith('#')]
        return lines
    except requests.exceptions.RequestException as e:
        print(f"[ERROR] Failed to download CIDRs: {e}")
        return []

def generate_mikrotik_script(cidrs):
    """将CIDR列表转换为Mikrotik脚本格式"""
    print(f"[CONVERT] Generating Mikrotik script for {len(cidrs)} CIDRs.")
    
    timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
    
    script_lines = []
    
    # 脚本头部注释
    script_lines.append(f"#: Generated: {timestamp}")
    script_lines.append(f"#: Source: {CIDRS_CN_URL} & Static List")
    script_lines.append(f"#: List Name: {ADDRESS_LIST_NAME}")
    script_lines.append(f"#: Count: {len(cidrs) + len(STATIC_LOCAL_NETS)}")
    script_lines.append("")
    
    # 1. 移除旧列表 (非常重要，否则会不断累加)
    script_lines.append(f"/ip firewall address-list remove [find list=\"{ADDRESS_LIST_NAME}\"]")
    
    # 2. 命令行头
    script_lines.append("/ip firewall address-list")
    
    # 3. 添加所有下载的 CN IP 地址
    for cidr in cidrs:
        script_lines.append(f"add list={ADDRESS_LIST_NAME} address={cidr} comment=\"{COMMENT}\"")
    
    # 4. 添加手动指定的本地网段
    for net in STATIC_LOCAL_NETS:
        script_lines.append(f"add list={ADDRESS_LIST_NAME} address={net} comment=\"Static Local Net\"")
        
    return "\n".join(script_lines)

def main():
    # 确保 output 目录存在
    # os.path.dirname("output/mikrotik_cn_ip.rsc") 是 "output"
    os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)
    
    cidrs = fetch_cidrs(CIDRS_CN_URL)
    
    if not cidrs:
        print("[FAIL] No CIDRs obtained. Skipping script generation.")
        return
        
    mikrotik_script = generate_mikrotik_script(cidrs)
    
    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        f.write(mikrotik_script)
        
    print(f"[DONE] Mikrotik script saved to {OUTPUT_FILE}")

if __name__ == "__main__":
    main()
